<!DOCTYPE html>
<html>
<head>
    <title>Check Sync - Wild Fitness</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        pre {
            background: #000;
            padding: 20px;
            border: 2px solid #0f0;
            border-radius: 8px;
            overflow-x: auto;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .info {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #0f0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Wild Fitness - Check Sync Status</h1>
    
    <div class="info">
        <strong>Fecha actual:</strong> <span id="currentDate"></span><br>
        <strong>localStorage key:</strong> wild_fitness_activities
    </div>
    
    <button onclick="checkData()">ğŸ”„ Verificar Datos</button>
    <button onclick="clearData()">ğŸ—‘ï¸ Limpiar localStorage</button>
    <button onclick="testBroadcast()">ğŸ“¡ Test BroadcastChannel</button>
    
    <h2>ğŸ“Š Datos en localStorage:</h2>
    <pre id="output"></pre>
    
    <h2>ğŸ“ Log de Eventos:</h2>
    <pre id="log"></pre>

    <script>
        // VARIABLES GLOBALES
        const STORAGE_KEY = 'wild_fitness_activities';
        let logEl, outputEl, dateEl;
        
        // INICIALIZACIÃ“N
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ PÃ¡gina cargada');
            
            // Obtener elementos del DOM
            logEl = document.getElementById('log');
            outputEl = document.getElementById('output');
            dateEl = document.getElementById('currentDate');
            
            // Mostrar fecha actual
            if (dateEl) {
                dateEl.textContent = new Date().toISOString().split('T')[0];
            }
            
            // Log inicial
            log('ğŸš€ Sistema iniciado correctamente');
            log('âœ… Botones cargados y listos');
            
            // Auto-check
            checkData();
            
            // Listen for storage changes
            window.addEventListener('storage', (e) => {
                if (e.key === STORAGE_KEY) {
                    log('ğŸ”„ Storage event detectado');
                    checkData();
                }
            });
            
            // Listen for broadcast messages
            try {
                const channel = new BroadcastChannel('wild_fitness_sync');
                channel.onmessage = (e) => {
                    log('ğŸ“¡ Broadcast recibido: ' + JSON.stringify(e.data));
                    if (e.data.type === 'activities_updated') {
                        checkData();
                    }
                };
                log('âœ… BroadcastChannel listener activado');
            } catch (e) {
                log('âš ï¸ BroadcastChannel no disponible: ' + e.message);
            }
        });
        
        // FUNCIONES
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const fullMessage = `[${timestamp}] ${message}`;
            
            console.log(fullMessage);
            
            if (logEl) {
                logEl.textContent += fullMessage + '\n';
                logEl.scrollTop = logEl.scrollHeight;
            }
        }
        
        function checkData() {
            log('ğŸ” Verificando datos...');
            
            if (!outputEl) {
                console.error('âŒ Elemento output no encontrado');
                return;
            }
            
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                
                if (!stored || stored === 'null' || stored === 'undefined') {
                    outputEl.textContent = 'âŒ No hay datos en localStorage\n\nKey: ' + STORAGE_KEY;
                    log('âŒ localStorage estÃ¡ vacÃ­o');
                    return;
                }
                
                const activities = JSON.parse(stored);
                
                if (!Array.isArray(activities)) {
                    outputEl.textContent = 'âŒ Los datos no son un array vÃ¡lido';
                    log('âŒ Datos invÃ¡lidos en localStorage');
                    return;
                }
                
                outputEl.textContent = JSON.stringify(activities, null, 2);
                log(`âœ… ${activities.length} actividades encontradas`);
                
                // Check dates
                const today = new Date().toISOString().split('T')[0];
                const future = activities.filter(a => a.date >= today);
                log(`ğŸ“… Hoy: ${today}`);
                log(`ğŸ“… Actividades futuras: ${future.length}/${activities.length}`);
                
                activities.forEach((a, index) => {
                    const isFuture = a.date >= today;
                    log(`  ${index + 1}. ${a.title || 'Sin tÃ­tulo'}: ${a.date} ${isFuture ? 'âœ… FUTURA' : 'âŒ PASADA'}`);
                });
                
            } catch (e) {
                outputEl.textContent = 'âŒ Error parseando JSON:\n\n' + e.message + '\n\nDatos raw:\n' + stored;
                log('âŒ Error: ' + e.message);
                console.error('Error completo:', e);
            }
        }
        
        function clearData() {
            log('ğŸ—‘ï¸ Solicitud de limpieza');
            
            if (confirm('Â¿Seguro que quieres limpiar TODOS los datos?\n\nEsta acciÃ³n NO se puede deshacer.')) {
                try {
                    localStorage.removeItem(STORAGE_KEY);
                    outputEl.textContent = 'ğŸ—‘ï¸ Datos eliminados correctamente';
                    log('âœ… localStorage limpiado');
                } catch (e) {
                    log('âŒ Error al limpiar: ' + e.message);
                }
            } else {
                log('âŒ Limpieza cancelada por el usuario');
            }
        }
        
        function testBroadcast() {
            log('ğŸ“¡ Iniciando test de BroadcastChannel...');
            
            try {
                const channel = new BroadcastChannel('wild_fitness_sync');
                
                channel.onmessage = (e) => {
                    log('âœ… Mensaje recibido: ' + JSON.stringify(e.data));
                };
                
                const testMessage = {
                    type: 'test',
                    message: 'Test message from check_sync.html',
                    timestamp: Date.now()
                };
                
                channel.postMessage(testMessage);
                log('ğŸ“¡ Test enviado: ' + JSON.stringify(testMessage));
                
                setTimeout(() => {
                    channel.close();
                    log('ğŸ“¡ Canal cerrado');
                }, 2000);
                
            } catch (e) {
                log('âŒ BroadcastChannel error: ' + e.message);
                console.error('BroadcastChannel error:', e);
            }
        }
    </script>
</body>
</html>
